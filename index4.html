<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Saham (History + Prediksi)</title>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    #chart { width: 100%; height: 560px; }
    button { cursor: pointer; }
    small { color: #555; }
  </style>
</head>

<body>
  <h2>Grafik History dan Prediksi Saham</h2>

  <div class="row">
    <label>Pilih saham:</label>
    <select id="symbol">
      <option value="BBCA">BBCA</option>
      <option value="BBRI">BBRI</option>
      <option value="BBNI">BBNI</option>
      <option value="BMRI">BMRI</option>
    </select>

    <button id="btnLoad">Tampilkan</button>
    <button id="btnReset">Reset Zoom</button>
    <small>Tip: drag untuk zoom, double click untuk reset, slider bawah untuk geser periode</small>
  </div>

  <p id="status"></p>
  <div id="chart"></div>

<script>
const API_BASE = "https://prediksiregresi-production.up.railway.app";

// === default range ===
const DEFAULT_HISTORY_DAYS = 14; // 2 minggu
const DEFAULT_PRED_DAYS = 7;     // 1 minggu (sesuai API kamu)

async function safeFetch(url) {
  const r = await fetch(url, { cache: "no-store" });
  const text = await r.text();
  try { return JSON.parse(text); }
  catch { return { error: "Response bukan JSON: " + text.slice(0, 200) }; }
}

function padNulls(arr, nNulls) {
  return [...arr, ...Array(nNulls).fill(null)];
}

function lastNDaysRange(endDateStr, nDays) {
  // endDateStr: "YYYY-MM-DD"
  const end = new Date(endDateStr + "T00:00:00");
  const start = new Date(end);
  start.setDate(start.getDate() - nDays); // 14 hari kebelakang (kalender)
  const toISO = (d) => d.toISOString().slice(0,10);
  return [toISO(start), toISO(end)];
}

async function loadChart() {
  const status = document.getElementById("status");
  const symbol = document.getElementById("symbol").value;

  status.innerText = "Loading data...";

  const history = await safeFetch(`${API_BASE}/history/${symbol}`);
  const prediction = await safeFetch(`${API_BASE}/predict/${symbol}`);

  if (history.error) { status.innerText = "Error history: " + history.error; return; }
  if (prediction.error) { status.innerText = "Error predict: " + prediction.error; return; }

  const histDates = history.dates;        // array "YYYY-MM-DD"
  const histPrices = history.close;       // array number
  const predDates = prediction.predictions.map(p => p.date);
  const predPrices = prediction.predictions.map(p => p.predicted_close);

  // gabungkan timeline agar prediksi nyambung
  const allDates = [...histDates, ...predDates];
  const historySeries = padNulls(histPrices, predPrices.length);
  const predSeries = [...Array(histPrices.length).fill(null), ...predPrices];

  const traceHistory = {
    x: allDates,
    y: historySeries,
    type: "scatter",
    mode: "lines",
    name: "History / Actual",
    line: { width: 3, color: "blue" }
  };

  const tracePred = {
    x: allDates,
    y: predSeries,
    type: "scatter",
    mode: "lines",
    name: "Prediksi (7 hari bursa)",
    line: { width: 4, color: "red" } // merah solid tebal
  };

  // === set default view: 2 minggu terakhir history + 1 minggu prediksi ===
  // ambil tanggal terakhir dari history (biasanya hari terakhir bursa yang tersedia)
  const lastHistDate = histDates[histDates.length - 1];
  const [rangeStart, rangeEnd] = lastNDaysRange(lastHistDate, DEFAULT_HISTORY_DAYS);

  const layout = {
    title: {
      text: `Grafik History + Prediksi (${symbol})`,
      x: 0.5,
      y: 0.98
    },
    template: "plotly_white",

    // Bikin ruang atas lebih lega supaya judul + legend + range buttons tidak tabrakan
    margin: { l: 70, r: 25, t: 120, b: 70 },

    xaxis: {
      type: "date",

      // default range: start 2 minggu sebelum last history, end sampai + prediksi (biar prediksi ikut keliatan)
      range: [rangeStart, predDates[predDates.length - 1] ?? rangeEnd],

      rangeselector: {
        y: 1.08,            // taruh tombol agak di atas area plot, tapi masih aman dari judul
        x: 0,
        xanchor: "left",
        buttons: [
          { count: 7, label: "7D", step: "day", stepmode: "backward" },
          { count: 14, label: "2W", step: "day", stepmode: "backward" },
          { count: 1, label: "1M", step: "month", stepmode: "backward" },
          { count: 3, label: "3M", step: "month", stepmode: "backward" },
          { count: 6, label: "6M", step: "month", stepmode: "backward" },
          { count: 1, label: "YTD", step: "year", stepmode: "todate" },
          { count: 1, label: "1Y", step: "year", stepmode: "backward" },
          { step: "all", label: "All" }
        ]
      },

      // slider bawah untuk geser kiri-kanan
      rangeslider: { visible: true }
    },

    yaxis: { title: "Harga (Close)" },

    // Legend dipindah ke bawah judul (tidak nabrak judul)
    legend: {
      orientation: "h",
      x: 0.5,
      xanchor: "center",
      y: 1.02,
      yanchor: "bottom"
    }
  };

  const config = {
    responsive: true,
    scrollZoom: true,   // zoom pakai scroll
    displaylogo: false
  };

  Plotly.newPlot("chart", [traceHistory, tracePred], layout, config);

  status.innerText =
    `Kode (${symbol}) | History: ${histPrices.length} hari | Prediksi: ${predPrices.length} hari`;
}

function resetZoom() {
  // reset ke default 2 minggu history + 1 minggu prediksi
  const symbol = document.getElementById("symbol").value;

  safeFetch(`${API_BASE}/history/${symbol}`).then(history => {
    if (history.error) return Plotly.relayout("chart", { "xaxis.autorange": true, "yaxis.autorange": true });

    const histDates = history.dates;
    const lastHistDate = histDates[histDates.length - 1];
    const [rangeStart, rangeEnd] = lastNDaysRange(lastHistDate, DEFAULT_HISTORY_DAYS);

    // ambil prediksi untuk ujung kanan (biar prediksi tetap ikut terlihat)
    safeFetch(`${API_BASE}/predict/${symbol}`).then(pred => {
      const predDates = pred?.predictions?.map(p => p.date) || [];
      const rightEnd = predDates[predDates.length - 1] || rangeEnd;

      Plotly.relayout("chart", {
        "xaxis.range": [rangeStart, rightEnd],
        "yaxis.autorange": true
      });
    });
  });
}

document.getElementById("btnLoad").addEventListener("click", loadChart);
document.getElementById("btnReset").addEventListener("click", resetZoom);

// auto load + refresh tiap 15 menit
loadChart();
setInterval(loadChart, 15 * 60 * 1000);
</script>
</body>
</html>
