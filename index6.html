<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Grafik History dan Prediksi Saham</title>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    #chart { width: 100%; height: 560px; }
    #status { margin-top: 10px; }
    .muted { color:#555; }
  </style>
</head>

<body>
  <h2>Grafik History dan Prediksi Saham</h2>

  <div class="row">
    <label>Pilih saham:</label>
    <select id="symbol">
      <option value="BBCA">BBCA</option>
      <option value="BBRI">BBRI</option>
      <option value="BBNI">BBNI</option>
      <option value="BMRI">BMRI</option>
    </select>

    <button id="btnLoad">Tampilkan</button>
  </div>

  <p id="status" class="muted"></p>
  <div id="chart"></div>

<script>
const API_BASE = "https://prediksiregresi-production.up.railway.app";

// default view
const DEFAULT_HISTORY_DAYS = 14; // 2 minggu
const DEFAULT_PRED_DAYS = 7;     // 1 minggu (dari API biasanya 7)

// ---------- helpers ----------
async function safeFetch(url) {
  const r = await fetch(url, { cache: "no-store" });
  const text = await r.text();
  try { return JSON.parse(text); }
  catch { return { error: "Response bukan JSON", raw: text?.slice(0,200) }; }
}

function iso(d) { return d.toISOString().slice(0,10); }

function addDays(dateStr, n) {
  const d = new Date(dateStr + "T00:00:00");
  d.setDate(d.getDate() + n);
  return iso(d);
}

function lastNDaysRange(endDateStr, nDays) {
  const end = new Date(endDateStr + "T00:00:00");
  const start = new Date(end);
  start.setDate(start.getDate() - nDays);
  return [iso(start), iso(end)];
}

function fmtNum(x) {
  if (x === null || x === undefined || Number.isNaN(x)) return "-";
  // rapikan: 2 desimal jika kecil, tanpa desimal jika besar
  const n = Number(x);
  if (!Number.isFinite(n)) return String(x);
  if (Math.abs(n) >= 100) return n.toFixed(0);
  return n.toFixed(2);
}

// ---------- main ----------
async function loadChart() {
  const status = document.getElementById("status");
  const symbol = document.getElementById("symbol").value;

  status.innerText = "Loading data...";

  const [history, prediction, metrics] = await Promise.all([
    safeFetch(`${API_BASE}/history/${symbol}`),
    safeFetch(`${API_BASE}/predict/${symbol}`),
    safeFetch(`${API_BASE}/metrics/${symbol}`), // jika belum ada, akan tampil "N/A"
  ]);

  if (history.error) {
    status.innerText = `Gagal memuat history: ${history.error}${history.raw ? " | " + history.raw : ""}`;
    return;
  }
  if (prediction.error) {
    status.innerText = `Gagal memuat prediksi: ${prediction.error}${prediction.raw ? " | " + prediction.raw : ""}`;
    return;
  }

  const histDates = history.dates || [];
  const histPrices = history.close || [];

  const predList = prediction.predictions || [];
  const predDates = predList.map(p => p.date);
  const predPrices = predList.map(p => p.predicted_close);

  if (histDates.length === 0 || histPrices.length === 0) {
    status.innerText = "History kosong.";
    return;
  }
  if (predDates.length === 0 || predPrices.length === 0) {
    status.innerText = "Prediksi kosong.";
    return;
  }

  // --- build combined axis ---
  const allDates = [...histDates, ...predDates];

  // history sampai habis; di area prediksi dibuat null supaya tidak nyambung
  const histSeries = [...histPrices, ...Array(predPrices.length).fill(null)];

  // prediksi: null sepanjang history, baru isi prediksi
  const predSeries = [...Array(histPrices.length).fill(null), ...predPrices];

  // --- default range: 2 minggu terakhir history + 7 hari prediksi ---
  const lastHistDate = histDates[histDates.length - 1];
  const [rangeStart] = lastNDaysRange(lastHistDate, DEFAULT_HISTORY_DAYS);
  const rangeEnd = predDates[predDates.length - 1]; // kunci sampai prediksi terakhir

  // batas minimal: tanggal history paling awal
  const firstHistDate = histDates[0];

  // --- traces ---
  const traceHistory = {
    x: allDates,
    y: histSeries,
    type: "scatter",
    mode: "lines",
    name: "History / Actual",
    line: { color: "blue", width: 3 },
    hovertemplate: "%{x}<br>Actual: %{y}<extra></extra>"
  };

  const tracePred = {
    x: allDates,
    y: predSeries,
    type: "scatter",
    mode: "lines",
    name: `Prediksi (${predPrices.length} hari bursa)`,
    line: { color: "red", width: 4 },
    hovertemplate: "%{x}<br>Pred: %{y}<extra></extra>"
  };

  // --- shaded area untuk zona prediksi (dari predDates[0] s/d predDates[last]) ---
  // Plotly shading pakai layout.shapes rect
  const shapes = [
    {
      type: "rect",
      xref: "x",
      yref: "paper",
      x0: predDates[0],
      x1: predDates[predDates.length - 1],
      y0: 0,
      y1: 1,
      fillcolor: "rgba(255,0,0,0.08)", // merah muda tipis
      line: { width: 0 }
    }
  ];

  // --- rangeselector buttons ---
  const layout = {
    template: "plotly_white",
    margin: { l: 70, r: 30, t: 90, b: 70 },
    shapes,

    title: { text: `Grafik History + Prediksi (${symbol})`, x: 0.5 },

    xaxis: {
      type: "date",

      // default tampilan awal
      range: [rangeStart, rangeEnd],

      // ðŸ”’ kunci agar tidak bisa melewati prediksi terakhir (tidak tampil area kosong)
      rangebounds: { min: firstHistDate, max: rangeEnd },

      rangeselector: {
        buttons: [
          { count: 1, label: "1M", step: "month", stepmode: "backward" },
          { count: 3, label: "3M", step: "month", stepmode: "backward" },
          { count: 6, label: "6M", step: "month", stepmode: "backward" },
          { count: 1, label: "YTD", step: "year", stepmode: "todate" },
          { count: 1, label: "1Y", step: "year", stepmode: "backward" },
          { step: "all", label: "All" }
        ],
        x: 0,
        y: 1.12
      },

      rangeslider: { visible: true }
    },

    yaxis: { title: "Harga (Close)" },

    legend: {
      orientation: "h",
      x: 0.5,
      xanchor: "center",
      y: 1.02,
      yanchor: "bottom"
    }
  };

  const config = {
    responsive: true,
    scrollZoom: true,     // wheel zoom
    displaylogo: false
  };

  Plotly.newPlot("chart", [traceHistory, tracePred], layout, config);

  // --- status + metrics ---
  const hasMetrics = metrics && !metrics.error && (metrics.mae !== undefined || metrics.rmse !== undefined || metrics.mape !== undefined);

  const mae  = hasMetrics ? fmtNum(metrics.mae)  : "N/A";
  const rmse = hasMetrics ? fmtNum(metrics.rmse) : "N/A";
  const mape = hasMetrics ? fmtNum(metrics.mape) : "N/A";

  status.innerText =
    `Kode (${symbol}) | History: ${histPrices.length} hari | Prediksi: ${predPrices.length} hari | MAE: ${mae} | RMSE: ${rmse} | MAPE: ${mape}`;
}

document.getElementById("btnLoad").addEventListener("click", loadChart);
loadChart();
</script>
</body>
</html>
